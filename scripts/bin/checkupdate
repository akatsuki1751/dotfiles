#!/bin/bash

upgrade_info=$(paru -Q --upgrades 2>/dev/null)

if [ $? -eq 1 ]; then
  if [ "$upgrade_info" != "" ]; then
    echo "cannot request the server. check network"
    exit 1
  else
    result=$(echo | jq -n '{"update_num": 0, "packge_name":[]}')
    echo "$result"
    exit 0
  fi
fi

count=$(echo upgrade_info | wc -l)
packges=$(echo "$upgrade_info" | jq -R -s 'split("\n")[:-1]')

result=$(echo | jq -n --argjson update_num "$count" --argjson packge_name "$packges" '{update_num: $update_num, packge_name: $packge_name}')

echo "$result"
exit 0
